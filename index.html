<!DOCTYPE html>
<html lang="zh-CN" data-theme="light" data-color-theme="black-white">
<head>
   <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

    <title>传讯</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" type="image/png" sizes="192x192" href="https://file.youtochat.com/images/20260216/1771224856844_qdqqd.jpeg">
<link rel="apple-touch-icon" href="https://file.youtochat.com/images/20260216/1771224856844_qdqqd.jpeg">
<meta name="apple-mobile-web-app-title" content="ʚ𝑳𝑶𝑽𝑬ɞ">
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="tour-overlay" class="tour-overlay">
    <div id="tour-highlight-box" class="tour-highlight-box"></div>
    <div id="tour-popover" class="tour-popover">
        <div class="tour-popover-header">
            <span id="tour-title" class="tour-title"></span>
            <span id="tour-step-counter" class="tour-step-counter"></span>
        </div>
        <div id="tour-content" class="tour-popover-content"></div>
        <div class="tour-popover-footer">
            <button id="tour-skip-btn" class="tour-btn tour-btn-skip">跳过</button>
            <div class="tour-navigation">
                <button id="tour-prev-btn" class="tour-btn"><i class="fas fa-arrow-left"></i> 上一步</button>
                <button id="tour-next-btn" class="tour-btn tour-btn-primary">下一步 <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
</div>

    <div class="welcome-animation" id="welcome-animation">
        <div class="welcome-bg-gradient"></div>
        <div class="stars-container" id="stars-container"></div>
        <div class="welcome-particles" id="welcome-particles"></div>
        <div id="welcome-meteors" style="position:absolute;inset:0;pointer-events:none;overflow:hidden;"></div>
        <div class="welcome-content-wrapper">
            <div class="logo-tech-container">
                <div class="logo-circle-outer"></div>
                <div class="logo-circle-inner"></div>
                <div class="logo-icon-main">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <div class="orbit-dot"></div>
                <div class="orbit-dot-2"></div>
                <div class="orbit-dot-3"></div>
            </div>

            <div class="text-tech-container">
                <div class="welcome-title-glitch" id="welcome-title-glitch" data-text="传讯">
                    加载失败
                </div>
                <div class="welcome-subtitle-scramble" id="welcome-subtitle-scramble">
                    请重试／更换平台/更换网络
                </div>
            </div>

            <div class="loader-tech">
                <div class="loader-tech-bar" id="loader-tech-bar"></div>
            </div>
            <div id="loader-status-text" style="font-size:10px;opacity:0.5;letter-spacing:1px;color:var(--welcome-text-sub);margin-top:4px;font-family:monospace;"></div>
        </div>
    </div>
    <button id="immersive-exit-btn" onclick="toggleImmersiveMode(false)" title="退出沉浸模式">
<i class="fas fa-expand"></i>
</button>
    <div class="header">
        <div class="header-motto"></div>
        <div class="header-inner">
         <div class="user-info">
                <div id="partner-name" class="username">
                    梦角
                </div>
                <div id="partner-avatar-container" class="avatar-container">
                    <div class="avatar" id="partner-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="status" id="partner-status">
                    <span>在线</span>
                </div>
            </div>
            <div class="header-actions">
                <button id="session-manager-btn" class="action-btn" title="会话管理"><i class="fas fa-comments"></i></button>
                <button id="group-chat-btn" class="action-btn" title="群聊设置"><i class="fas fa-users"></i></button>
                <button id="daily-greeting-btn" class="action-btn" title="今日公告" onclick="reopenDailyGreeting()"><i class="fas fa-newspaper"></i></button>
                <button id="theme-toggle" class="action-btn" title="切换主题"><i class="fas fa-moon"></i></button>
                <button id="settings-btn" class="action-btn" title="设置"><i class="fas fa-cog"></i></button>
            </div>
             <div class="user-info">
                <div class="username" id="my-name">
                    我
                </div>
               
                <div id="my-avatar-container" class="avatar-container">
                    <div class="avatar" id="my-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
               
                <div class="status" id="my-status-container">
                    <span id="my-status-text">在线</span>
                </div>
            </div>
        </div>
    </div>
    <div class="main-chat-area">

        <div class="history-loader" id="history-loader">
            <div class="history-spinner"></div>
        </div>

        <div class="chat-container" id="chat-container">
    </div>
    <div class="empty-state" id="empty-state" style="display:none;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px;width:100%;pointer-events:none;z-index:1;">
            <div style="position:relative;margin-bottom:20px;">
                <i class="fas fa-heart" style="font-size:52px;opacity:0.55;color:var(--accent-color);"></i>
                <i class="fas fa-comment-dots" style="position:absolute;bottom:-6px;right:-10px;font-size:26px;opacity:0.65;color:var(--accent-color);"></i>
            </div>
            <p style="font-size:15px;font-weight:600;color:var(--accent-color);opacity:0.9;letter-spacing:1px;">✦ 我们的故事，始于此刻 ✦</p>
            <p style="font-size:12px;margin-top:8px;opacity:0.65;letter-spacing:0.5px;color:var(--text-secondary);">说点什么，让对话开始吧</p>
    </div>
    <div id="typing-indicator-wrapper">
        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-indicator-avatar" id="typing-indicator-avatar">
                <i class="fas fa-user"></i>
            </div>
            <span class="typing-indicator-label" id="typing-indicator-label"></span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    </div>

    <div id="ti-settings-modal">
        <div id="ti-settings-panel">
            <div class="ti-settings-header">
                <div class="ti-settings-icon">💬</div>
                <div>
                    <div class="ti-settings-title">正在输入</div>
                </div>
                <button class="ti-settings-close" id="ti-settings-close-btn">×</button>
            </div>
            <div class="ti-settings-body">
                <div class="ti-settings-row">
                    <div class="ti-settings-row-label">
                        <div class="ti-settings-row-icon">❤︎</div>
                        <div>
                            <div class="ti-settings-row-text">显示头像</div>
                            <div class="ti-settings-row-sub">在指示器左侧显示对方头像</div>
                        </div>
                    </div>
                    <div class="setting-pill-row" id="ti-avatar-toggle" style="pointer-events:auto;cursor:pointer;background:var(--primary-bg);border-radius:14px;padding:10px 14px;border:1px solid var(--border-color);">
                        <div class="setting-pill-switch" id="ti-avatar-pill"><div class="setting-pill-knob"></div></div>
                    </div>
                </div>

                <div class="ti-text-edit-row">
                    <div class="ti-text-edit-label">
                        <i class="fas fa-pen" style="font-size:11px;color:var(--accent-color);"></i>
                        <span>自定义文案</span>
                        <button class="ti-text-reset-btn" id="ti-text-reset-btn">恢复默认</button>
                    </div>
                    <div class="ti-text-input-wrap">
                        <input class="ti-text-input" id="ti-text-input" type="text" maxlength="20" placeholder="例：正在输入…">
                        <button class="ti-text-save-btn" id="ti-text-save-btn">保存</button>
                    </div>
                </div>

                <div>
                    <div class="ti-text-edit-label" style="margin-bottom:8px;">
                        <i class="fas fa-eye" style="font-size:11px;color:var(--accent-color);"></i>
                        <span>预览效果</span>
                    </div>
                    <div class="ti-preview-box">
                        <div id="ti-preview-avatar" style="width:30px;height:30px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.15);border:2px solid rgba(var(--accent-color-rgb),0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;">
                            <i class="fas fa-user" style="font-size:12px;color:var(--accent-color);"></i>
                        </div>
                        <span id="ti-preview-text" style="font-size:11.5px;font-weight:600;color:var(--accent-color);opacity:0.88;letter-spacing:0.4px;"></span>
                        <div class="ti-preview-dots">
                            <div class="ti-preview-dot"></div>
                            <div class="ti-preview-dot"></div>
                            <div class="ti-preview-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="input-area-wrapper">
        <div class="batch-preview" id="batch-preview"></div>
        <div id="reply-preview-container"></div>
        <div class="input-area">
    <button class="attachment-btn input-btn" id="attachment-btn" title="发送图片"><i class="fas fa-image"></i></button>
    
    <button class="combo-btn input-btn" id="combo-btn" title="表情 & 拍一拍">
        <i class="fas fa-laugh-beam"></i>
    </button>

    <textarea class="message-input" id="message-input" placeholder="" rows="1"></textarea>
    
    <div class="input-buttons">
    <button class="continue-btn input-btn" id="continue-btn" title="让对方继续说"><i class="fas fa-ellipsis-h"></i></button>
        <button class="batch-btn input-btn" id="batch-btn" title="批量发送模式"><i class="fas fa-layer-group"></i></button>
        <button class="send-btn input-btn" id="send-btn" title="发送消息"><i class="fas fa-paper-plane"></i></button>
        
        <div class="sticker-picker-popover" id="user-sticker-picker">
            <div class="combo-tabs-header">
                <button class="combo-tab-btn active" data-tab="my-sticker"><i class="fas fa-user" style="font-size:10px;"></i> 我</button>
                <button class="combo-tab-btn" data-tab="partner-sticker"><i class="fas fa-heart" style="font-size:10px;"></i> 对方</button>
                <button class="combo-tab-btn" data-tab="poke">拍一拍</button>
                <div style="margin-left:auto;display:flex;align-items:center;gap:4px;">
                    <button id="sticker-add-btn" onclick="document.getElementById('my-sticker-quick-upload').click()" title="添加我的表情" style="background:var(--accent-color);border:none;cursor:pointer;padding:4px 10px;color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;gap:4px;border-radius:8px;transition:all 0.2s;box-shadow:0 2px 8px rgba(var(--accent-color-rgb),0.35);" onmouseover="this.style.opacity='0.85';this.style.transform='scale(1.05)'" onmouseout="this.style.opacity='1';this.style.transform='scale(1)'"><i class="fas fa-plus"></i> 添加</button>
                    <button onclick="window.openMyStickerSettings()" title="管理表情库" style="background:none;border:none;cursor:pointer;padding:4px 8px;color:var(--text-secondary);font-size:12px;display:flex;align-items:center;gap:3px;border-radius:6px;transition:all 0.2s;" onmouseover="this.style.background='rgba(var(--accent-color-rgb),0.12)';this.style.color='var(--accent-color)'" onmouseout="this.style.background='none';this.style.color='var(--text-secondary)'"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <div class="combo-content-area" id="combo-content-area">
            </div>
        </div>
    </div>
    <input type="file" id="image-input" class="file-input" accept="image/*">
    <input type="file" id="my-sticker-quick-upload" class="file-input" accept="image/*" multiple>
</div>
    </div>


    <div class="modal" id="edit-modal" style="z-index:3000;">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-user-edit"></i><span id="edit-modal-title">修改昵称</span>
            </div>
            <input type="text" class="modal-input" id="name-input" placeholder="输入新昵称"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-edit">取消</button><button class="modal-btn modal-btn-primary" id="save-name" disabled>保存</button>
            </div>
        </div>
    </div>

    <div class="modal" id="avatar-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-portrait"></i><span id="avatar-modal-title">上传头像</span>
            </div>
            <input type="file" class="modal-input" id="avatar-input" accept="image/*"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-avatar">取消</button><button class="modal-btn modal-btn-primary" id="save-avatar">保存</button>
            </div>
        </div>
    </div>

    <div class="modal" id="note-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-sticky-note"></i><span>编辑注释</span>
            </div>
            <textarea class="modal-textarea" id="note-input" placeholder="为这条消息添加注释..."></textarea><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-note">取消</button><button class="modal-btn modal-btn-primary" id="save-note">保存</button>
            </div>
        </div>
    </div>

    <div class="modal" id="poke-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-hand-sparkles"></i><span>拍一拍</span>
            </div>
            <input type="text" class="modal-input" id="poke-input" placeholder="例如：拍了拍对方的肩膀"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-poke">取消</button><button class="modal-btn modal-btn-primary" id="send-poke">发送</button>
            </div>
        </div>
    </div>
<div class="modal" id="envelope-modal">
    <div class="modal-content" style="max-height:92vh; padding:0; overflow:hidden; background:transparent;">
    <div class="env-wrapper">
        <div class="env-header-flap">
            <svg class="env-header-icon" width="40" height="30" viewBox="0 0 40 30" fill="none">
                <rect x="1" y="7" width="38" height="22" rx="3" fill="rgba(255,255,255,0.18)" stroke="rgba(255,255,255,0.6)" stroke-width="1.5"/>
                <path d="M1 9 L20 20 L39 9" stroke="rgba(255,255,255,0.5)" stroke-width="1.2" fill="none"/>
                <path d="M1 29 L14 18" stroke="rgba(255,255,255,0.35)" stroke-width="1"/>
                <path d="M39 29 L26 18" stroke="rgba(255,255,255,0.35)" stroke-width="1"/>
            </svg>
            <div class="env-header-title">信 封 投 递</div>
            <div class="env-header-subtitle">Letters · Correspondence</div>
        </div>

        <div class="env-body">
            <div class="env-tab-bar">
                <button class="env-tab-btn active" id="env-tab-outbox" onclick="switchEnvTab('outbox')">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:4px;"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>寄出的信
                    <span id="env-outbox-badge" class="env-badge" style="display:none;"></span>
                </button>
                <button class="env-tab-btn" id="env-tab-inbox" onclick="switchEnvTab('inbox')">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:4px;"><path d="M22 13V19a2 2 0 01-2 2H4a2 2 0 01-2-2v-6"/><polyline points="15 3 21 3 21 9"/><line x1="21" y1="3" x2="10" y2="14"/></svg>收到的信
                    <span id="env-inbox-badge" class="env-badge" style="display:none;"></span>
                </button>
            </div>

            <div id="env-outbox-section">
                <div id="env-outbox-list"></div>
            </div>

            <div id="env-inbox-section" style="display:none;">
                <div id="env-inbox-list"></div>
            </div>

            <div id="env-compose-form" style="display:none;">
                <div class="env-compose-paper">
                    <div class="env-compose-heading">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        <span id="env-compose-title">写一封信</span>
                    </div>
                    <textarea id="envelope-input" placeholder="亲爱的，&#10;&#10;今天想跟你说..."></textarea>
                </div>
                <div style="display:flex; align-items:center; gap:8px; margin:4px 0 6px; font-size:12px; padding: 0 2px;">
                    <input type="checkbox" id="env-send-to-chat" style="width:15px;height:15px; cursor:pointer; accent-color:var(--accent-color);">
                    <label for="env-send-to-chat" style="cursor:pointer; color:var(--text-secondary);">同时发送到聊天记录</label>
                </div>
                <div class="env-send-info">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span id="env-reply-time-info">对方将在 10-24 小时内回信（8-12 句话）</span>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="modal-btn modal-btn-secondary" id="cancel-compose" onclick="cancelEnvelopeCompose()" style="flex:1;">取消</button>
                    <button class="modal-btn modal-btn-primary" id="send-envelope" style="flex:2;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px;"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>封 · 寄出
                    </button>
                </div>
            </div>
        </div>

        <div class="env-send-area" id="env-main-close-btn">
            <button class="env-write-btn" id="new-envelope-btn" onclick="openNewEnvelopeForm()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                提笔写信
            </button>
            <button class="env-close-btn" id="cancel-envelope">关闭</button>
        </div>
    </div>
    </div>
</div>

<div class="modal" id="envelope-view-modal" style="z-index:2100;">
    <div class="modal-content" style="overflow:hidden;padding:0;background:transparent;max-height:92vh;display:flex;flex-direction:column;">
    <div style="background:var(--secondary-bg);border-radius:20px;overflow:hidden;display:flex;flex-direction:column;max-height:92vh;">
        <div style="background:var(--accent-color);padding:0;position:relative;overflow:hidden;flex-shrink:0;">
            <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,0.04) 0px,rgba(255,255,255,0.04) 2px,transparent 2px,transparent 12px);pointer-events:none;"></div>
            <div style="position:relative;padding:14px 20px 12px;display:flex;align-items:center;justify-content:space-between;">
                <div style="display:flex;align-items:center;gap:10px;color:white;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                    <span id="env-view-title" style="font-size:14px;font-weight:700;letter-spacing:2px;">信件内容</span>
                </div>
                <div style="border:2px solid rgba(255,255,255,0.5);border-radius:50%;width:48px;height:48px;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0.7;">
                    <span style="font-size:7px;color:white;letter-spacing:0.5px;">已送达</span>
                    <span id="env-view-stamp-date" style="font-size:8px;color:white;font-weight:600;"></span>
                    <span style="font-size:6px;color:white;opacity:0.8;">DELIVERED</span>
                </div>
            </div>
        </div>

        <div style="padding:0;overflow-y:auto;flex:1;min-height:0;">
            <div id="env-view-content" style="display:none;">
                <div style="background:var(--primary-bg);margin:16px;border-radius:12px;border:1px solid var(--border-color);overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.06);">
                    <div style="height:6px;background:linear-gradient(90deg,var(--accent-color),rgba(var(--accent-color-rgb),0.4),var(--accent-color));"></div>
                    <div style="padding:20px 20px 16px;position:relative;">
                        <div style="position:absolute;left:52px;top:0;bottom:0;width:1px;background:rgba(220,80,80,0.15);pointer-events:none;"></div>
                        <div style="position:absolute;inset:0;background:repeating-linear-gradient(transparent,transparent 31px,rgba(var(--accent-color-rgb),0.06) 31px,rgba(var(--accent-color-rgb),0.06) 32px);pointer-events:none;border-radius:12px;"></div>
                        
                        <div style="position:relative;z-index:1;">
                            <div id="env-view-date-line" style="font-size:11px;color:var(--text-secondary);text-align:right;margin-bottom:16px;letter-spacing:1px;opacity:0.8;font-style:italic;"></div>
                            <div id="env-view-to-line" style="font-size:13px;color:var(--text-primary);margin-bottom:4px;font-weight:500;"></div>
                            <div id="env-view-greeting-line" style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;font-style:italic;opacity:0.8;"></div>
                            <div id="env-view-text" class="env-letter-paper" style="border:none;background:transparent;padding:0 0 0 8px;line-height:32px;margin-bottom:16px;"></div>
                            <div style="border-top:1px dashed rgba(var(--accent-color-rgb),0.25);margin:12px 0;"></div>
                            <div id="env-view-sign-date" style="font-size:11px;color:var(--text-secondary);text-align:right;margin-bottom:4px;letter-spacing:0.5px;"></div>
                            <div id="env-view-sign-name" style="font-size:14px;color:var(--accent-color);text-align:right;font-weight:600;letter-spacing:1px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="env-view-edit" style="display:none;padding:16px;">
                <div class="env-compose-paper" style="padding:14px;">
                    <textarea class="modal-textarea" id="env-edit-input" style="height:160px;background:transparent;border:none;outline:none;font-family:var(--font-family);font-size:14px;line-height:1.9;width:100%;resize:none;"></textarea>
                </div>
            </div>
        </div>

        <div class="modal-buttons" style="margin:0;padding:12px 18px 16px;border-top:1px solid var(--border-color);flex-shrink:0;">
            <button class="modal-btn modal-btn-secondary" id="close-env-view" onclick="closeEnvViewModal()">关闭</button>
            <button class="modal-btn modal-btn-secondary" id="env-view-edit-btn" onclick="toggleEnvEdit()">编辑</button>
            <button class="modal-btn modal-btn-primary" id="env-view-save-btn" onclick="saveEnvEdit()" style="display:none;">保存</button>
        </div>
    </div>
    </div>
</div>
<div class="modal" id="group-chat-modal">
    <div class="modal-content">
        <div class="modal-title">
            <i class="fas fa-users"></i><span>群聊设置</span>
        </div>

        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-toggle-on"></i>群聊模式</div>
            <div id="group-mode-toggle" style="display:flex;align-items:center;gap:12px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:12px;padding:12px 14px;cursor:pointer;transition:all 0.2s;">
                <div style="width:36px;height:36px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <i id="group-mode-icon" class="fas fa-users" style="font-size:18px;color:var(--accent-color);"></i>
                </div>
                <div style="flex:1;">
                    <div style="font-size:13px;font-weight:600;color:var(--text-primary);">群聊模式</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;" id="group-mode-status">已关闭 — 点击开启</div>
                </div>
                <div id="group-mode-pill" style="width:44px;height:24px;border-radius:24px;background:var(--border-color);position:relative;transition:background 0.3s;flex-shrink:0;">
                    <div id="group-mode-knob" style="position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;left:3px;transition:left 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                </div>
            </div>
        </div>

        <div class="settings-section" id="group-display-section" style="display:none;">
            <div class="settings-section-title"><i class="fas fa-eye"></i>显示选项</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <div id="group-show-name-toggle" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:10px;cursor:pointer;">
                    <i class="fas fa-tag" style="color:var(--accent-color);width:18px;"></i>
                    <span style="flex:1;font-size:13px;">显示成员名称</span>
                    <div id="group-show-name-pill" style="width:36px;height:20px;border-radius:20px;background:var(--accent-color);position:relative;transition:background 0.3s;">
                        <div id="group-show-name-knob" style="position:absolute;width:14px;height:14px;border-radius:50%;background:#fff;top:3px;right:3px;transition:right 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section" id="group-members-section" style="display:none;">
            <div class="settings-section-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span><i class="fas fa-users"></i>群成员</span>
                <button onclick="openAddGroupMember()" class="modal-btn modal-btn-primary" style="padding:5px 12px;font-size:12px;"><i class="fas fa-plus"></i> 添加</button>
            </div>
            <div id="group-members-list" style="display:flex;flex-direction:column;gap:8px;max-height:220px;overflow-y:auto;"></div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="close-group-chat">关闭</button>
        </div>
    </div>
</div>

<div class="modal" id="group-member-edit-modal" style="z-index:2200;">
    <div class="modal-content" style="max-width:320px;">
        <div class="modal-title">
            <i class="fas fa-user-edit"></i><span id="group-member-edit-title">添加成员</span>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;padding:4px 0;">
            <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                <div id="group-member-avatar-preview" onclick="document.getElementById('group-member-avatar-input').click()" style="width:64px;height:64px;border-radius:50%;background:var(--primary-bg);border:2px dashed var(--border-color);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;flex-shrink:0;">
                    <i class="fas fa-camera" style="font-size:20px;color:var(--text-secondary);"></i>
                </div>
                <span style="font-size:11px;color:var(--text-secondary);">点击上传头像</span>
                <input type="file" id="group-member-avatar-input" accept="image/*" style="display:none;" onchange="previewGroupMemberAvatar(this)">
            </div>
            <div>
                <label style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">成员名字</label>
                <input type="text" id="group-member-name-input" placeholder="输入名字" maxlength="10" style="width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:10px;background:var(--primary-bg);color:var(--text-primary);font-size:14px;box-sizing:border-box;">
            </div>
        </div>
        <input type="hidden" id="group-member-edit-index">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeGroupMemberEdit()">取消</button>
            <button class="modal-btn modal-btn-primary" onclick="saveGroupMember()">保存</button>
        </div>
    </div>
</div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-cog"></i><span>设置</span>
            </div>

            <div class="settings-grid">
                <div class="settings-card" id="appearance-settings">
                    <i class="fas fa-palette"></i>
                    <span>外观设置</span>
                </div>
                <div class="settings-card" id="chat-settings">
                    <i class="fas fa-comments"></i>
                    <span>聊天设置</span>
                </div>
                <div class="settings-card" id="advanced-settings">
                    <i class="fas fa-tools"></i>
                    <span>高级功能</span>
                </div>
                <div class="settings-card" id="data-settings">
                    <i class="fas fa-database"></i>
                    <span>数据管理</span>
                </div>
            </div>


            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-settings">关闭</button>
            </div>
        </div>
    </div>


    <div class="modal" id="appearance-modal">
        <div class="modal-content">

<div class="modal-title" id="appearance-modal-title">
    <i class="fas fa-palette"></i><span>外观设置</span>
</div>

<div id="appearance-nav-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:4px 0 12px;">
    <div class="settings-card" onclick="showAppearancePanel('theme')" style="cursor:pointer;">
        <i class="fas fa-paint-roller"></i><span>主题配色</span>
    </div>
    <div class="settings-card" onclick="showAppearancePanel('font-bg')" style="cursor:pointer;">
        <i class="fas fa-font"></i><span>背景 & 字体</span>
    </div>
    <div class="settings-card" onclick="showAppearancePanel('bubble-css')" style="cursor:pointer;">
        <i class="fas fa-comment"></i><span>气泡 & CSS</span>
    </div>
    <div class="settings-card" onclick="showAppearancePanel('avatar')" style="cursor:pointer;">
        <i class="fas fa-user-circle"></i><span>聊天头像</span>
    </div>
</div>

<div id="appearance-panel-container" style="display:none;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
        <button onclick="hideAppearancePanel()" style="background:var(--primary-bg);border:1px solid var(--border-color);border-radius:10px;padding:6px 12px;font-size:12px;cursor:pointer;color:var(--text-secondary);">
            <i class="fas fa-arrow-left"></i> 返回
        </button>
        <span id="appearance-panel-title" style="font-size:14px;font-weight:600;color:var(--text-primary);"></span>
    </div>

    <div id="appearance-panel-theme" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-paint-roller"></i>主题配色</div>
            <div class="appearance-group" style="margin-bottom:0;">
                <div class="theme-editor-entry-btn" id="open-theme-editor">
                    <i class="fas fa-sliders-h"></i>
                    <span>自定义<br>编辑器</span>
                </div>
                <div class="preset-colors-container">
                    <div class="preset-colors-title"><i class="fas fa-swatchbook"></i> 快捷换肤</div>
                    <div class="theme-picker">
                        <button class="theme-color-btn" id="theme-gold" data-theme="gold" title="金色"></button>
                        <button class="theme-color-btn" id="theme-blue" data-theme="blue" title="蓝色"></button>
                        <button class="theme-color-btn" id="theme-purple" data-theme="purple" title="紫色"></button>
                        <button class="theme-color-btn" id="theme-green" data-theme="green" title="绿色"></button>
                        <button class="theme-color-btn" id="theme-pink" data-theme="pink" title="粉色"></button>
                        <button class="theme-color-btn" id="theme-black-white" data-theme="black-white" title="黑白"></button>
                        <button class="theme-color-btn" id="theme-pastel" data-theme="pastel" title="红色"></button>
                        <button class="theme-color-btn" id="theme-sunset" data-theme="sunset" title="橙色"></button>
                        <button class="theme-color-btn" id="theme-forest" data-theme="forest" title="深绿"></button>
                        <button class="theme-color-btn" id="theme-ocean" data-theme="ocean" title="深蓝"></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings-section" id="theme-schemes-section">
            <div class="settings-section-title">
                <i class="fas fa-layer-group"></i>主题方案
                <button id="save-theme-scheme-btn" class="modal-btn modal-btn-primary" style="padding:4px 10px; font-size:11px; margin-left:auto;">
                    <i class="fas fa-plus"></i> 保存当前
                </button>
            </div>
            <div style="font-size:11px;color:var(--text-secondary);opacity:0.7;margin-bottom:8px;">保存当前所有外观设置，方便快速切换</div>
            <div id="theme-schemes-list" class="theme-schemes-list">
                <div class="theme-schemes-empty" id="theme-schemes-empty">
                    <i class="fas fa-paint-brush"></i>
                    <span>暂无保存的方案，点击"保存当前"试试~</span>
                </div>
            </div>
        </div>
    </div>

    <div id="appearance-panel-font" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-font"></i>字体设置</div>
            <div class="font-size-control">
                <span class="font-size-label">大小:</span>
                <input type="range" min="12" max="24" value="16" class="font-size-slider" id="font-size-slider">
                <span class="font-size-value" id="font-size-value">16px</span>
            </div>
            <div style="margin-top: 10px;">
                <label style="font-size: 12px; color: var(--text-secondary); display:block; margin-bottom:5px;">字体链接 (CSS/TTF):</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="custom-font-url" class="modal-input" style="margin-bottom:0; font-size:12px;" placeholder="https://example.com/font.woff2">
                    <button id="apply-font-btn" class="modal-btn modal-btn-primary" style="padding: 5px 10px; font-size: 12px; white-space: nowrap;">应用</button>
                    <button id="follow-system-font-btn" class="modal-btn modal-btn-secondary" style="padding: 5px 10px; font-size: 12px; white-space: nowrap; margin-left: 5px;">跟随系统</button>
                </div>
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; opacity: 0.7;">
                    提示: 应用后将覆盖默认字体。留空并应用可恢复默认。
                </div>
            </div>
        </div>
    </div>

    <div id="appearance-panel-background" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title">
                <i class="fas fa-image"></i>聊天背景
                <input type="file" id="bg-gallery-input" accept="image/*" style="display: none;">
            </div>
            <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;opacity:0.75;line-height:1.5;">
                支持图片及 GIF 动图。点击 <i class="fas fa-plus" style="font-size:10px;"></i> 添加，点击项目应用。
            </div>
            <div class="bg-gallery" id="background-gallery-list"></div>
            <div style="text-align: center; margin-top: 10px;">
                <button class="modal-btn modal-btn-secondary" id="reset-default-bg" style="font-size: 12px; padding: 6px 12px;">
                    <i class="fas fa-undo"></i> 恢复默认背景
                </button>
            </div>
        </div>
    </div>

    <div id="appearance-panel-bubble" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title">
                <i class="fas fa-comment"></i>气泡样式
            </div>
            <div class="settings-item-list" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div class="settings-item" data-bubble-style="standard" style="justify-content:center;">
                    <i class="fas fa-comment"></i><span>标准尖角</span>
                </div>
                <div class="settings-item" data-bubble-style="rounded" style="justify-content:center;">
                    <i class="fas fa-comment-dots"></i><span>圆角</span>
                </div>
                <div class="settings-item" data-bubble-style="rounded-large" style="justify-content:center;">
                    <i class="fas fa-circle"></i><span>大圆角胶囊</span>
                </div>
                <div class="settings-item" data-bubble-style="square" style="justify-content:center;">
                    <i class="fas fa-square"></i><span>方形直角</span>
                </div>
            </div>

        </div>
    </div>

    <div id="appearance-panel-avatar" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-user-circle"></i>聊天头像</div>
            <div id="in-chat-avatar-toggle-2" style="display:flex;align-items:center;gap:12px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:12px;padding:12px 14px;cursor:pointer;transition:all 0.2s;margin-bottom:10px;">
                <div style="width:36px;height:36px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <i id="avatar-toggle-icon-2" class="fas fa-user-circle" style="font-size:18px;color:var(--accent-color);"></i>
                </div>
                <div style="flex:1;">
                    <div style="font-size:13px;font-weight:600;color:var(--text-primary);">显示聊天头像</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;" id="avatar-toggle-status-2">已开启 — 消息旁显示头像</div>
                </div>
                <div id="avatar-toggle-pill-2" style="width:44px;height:24px;border-radius:24px;background:var(--accent-color);position:relative;transition:background 0.3s;flex-shrink:0;">
                    <div id="avatar-toggle-knob-2" style="position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;right:3px;transition:right 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                </div>
            </div>
            <div class="font-size-control" id="in-chat-avatar-size-control-2">
                <span class="font-size-label">头像尺寸:</span>
                <input type="range" min="24" max="48" value="36" class="font-size-slider" id="in-chat-avatar-size-slider-2">
                <span class="font-size-value" id="in-chat-avatar-size-value-2">36px</span>
            </div>
            <div id="in-chat-avatar-position-control-2" style="margin-top:10px;">
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;font-weight:500;">头像对齐方式</div>
                <div style="display:flex;gap:8px;">
                    <button id="avatar-pos-top-2" class="modal-btn modal-btn-secondary" data-pos="top" style="flex:1;font-size:12px;padding:7px 0;"><i class="fas fa-arrow-up"></i> 顶部</button>
                    <button id="avatar-pos-center-2" class="modal-btn modal-btn-primary" data-pos="center" style="flex:1;font-size:12px;padding:7px 0;"><i class="fas fa-arrows-alt-v"></i> 居中</button>
                    <button id="avatar-pos-bottom-2" class="modal-btn modal-btn-secondary" data-pos="bottom" style="flex:1;font-size:12px;padding:7px 0;"><i class="fas fa-arrow-down"></i> 底部</button>
                </div>
            </div>
            <div id="avatar-bubble-preview" style="margin-top:14px;background:var(--chat-bg,var(--primary-bg));border-radius:14px;padding:14px 12px;border:1px solid var(--border-color);display:none;">
                <div style="font-size:11px;color:var(--text-secondary);margin-bottom:10px;opacity:0.7;text-align:center;letter-spacing:0.3px;">预览效果</div>
                <div class="preview-msg-row" style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;">
                    <div id="preview-partner-avatar" style="width:var(--in-chat-avatar-size,36px);height:var(--in-chat-avatar-size,36px);border-radius:50%;background:var(--border-color);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-user" style="font-size:14px;color:var(--text-secondary);"></i>
                    </div>
                    <div style="background:var(--message-received-bg);color:var(--message-received-text);border-radius:16px 16px 16px 4px;padding:9px 13px;font-size:13px;max-width:160px;">
                        你是我朝夕相伴触手可及的虚拟
                    </div>
                </div>
                <div class="preview-msg-row" style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end;">
                    <div style="background:var(--message-sent-bg);color:var(--message-sent-text);border-radius:16px 16px 4px 16px;padding:9px 13px;font-size:13px;max-width:160px;">
                        你是我未曾拥有无法捕捉的亲昵
                    </div>
                    <div id="preview-my-avatar" style="width:var(--in-chat-avatar-size,36px);height:var(--in-chat-avatar-size,36px);border-radius:50%;background:var(--border-color);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-user" style="font-size:14px;color:var(--text-secondary);"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-id-badge"></i>头像框设置</div>
            <h4 style="font-size:13px;font-weight:600;margin:10px 0 8px;color:var(--text-primary);">我的头像框</h4>
            <div class="frame-settings-container">
                <div class="frame-preview-wrapper">
                    <div class="frame-preview" id="my-frame-preview-2"></div>
                    <div style="display:flex;gap:8px;margin-top:6px;">
                        <button class="modal-btn modal-btn-secondary" id="my-frame-upload-btn-2" style="padding:5px 10px;font-size:12px;">上传</button>
                        <button class="modal-btn modal-btn-secondary" id="my-frame-remove-btn-2" style="padding:5px 10px;font-size:12px;">移除</button>
                    </div>
                </div>
                <div class="frame-controls">
                    <div class="frame-slider-group">
                        <label for="my-frame-size-2">大小</label>
                        <input type="range" id="my-frame-size-2" min="50" max="200" value="100">
                        <span id="my-frame-size-value-2" style="width:40px;text-align:right;">100%</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="my-frame-offset-x-2">左右</label>
                        <input type="range" id="my-frame-offset-x-2" min="-50" max="50" value="0">
                        <span id="my-frame-offset-x-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="my-frame-offset-y-2">上下</label>
                        <input type="range" id="my-frame-offset-y-2" min="-50" max="50" value="0">
                        <span id="my-frame-offset-y-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                </div>
            </div>
            <input type="file" id="my-frame-file-input-2" class="file-input" accept="image/png, image/webp, image/gif">

            <h4 style="font-size:13px;font-weight:600;margin:20px 0 8px;border-top:1px dashed var(--border-color);padding-top:14px;color:var(--text-primary);">梦角的头像框</h4>
            <div class="frame-settings-container">
                <div class="frame-preview-wrapper">
                    <div class="frame-preview" id="partner-frame-preview-2"></div>
                    <div style="display:flex;gap:8px;margin-top:6px;">
                        <button class="modal-btn modal-btn-secondary" id="partner-frame-upload-btn-2" style="padding:5px 10px;font-size:12px;">上传</button>
                        <button class="modal-btn modal-btn-secondary" id="partner-frame-remove-btn-2" style="padding:5px 10px;font-size:12px;">移除</button>
                    </div>
                </div>
                <div class="frame-controls">
                    <div class="frame-slider-group">
                        <label for="partner-frame-size-2">大小</label>
                        <input type="range" id="partner-frame-size-2" min="50" max="200" value="100">
                        <span id="partner-frame-size-value-2" style="width:40px;text-align:right;">100%</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="partner-frame-offset-x-2">左右</label>
                        <input type="range" id="partner-frame-offset-x-2" min="-50" max="50" value="0">
                        <span id="partner-frame-offset-x-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="partner-frame-offset-y-2">上下</label>
                        <input type="range" id="partner-frame-offset-y-2" min="-50" max="50" value="0">
                        <span id="partner-frame-offset-y-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                </div>
            </div>
            <input type="file" id="partner-frame-file-input-2" class="file-input" accept="image/png, image/webp, image/gif">
        </div>
    </div>

    <div id="appearance-panel-css" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-code"></i>自定义 CSS</div>
            <textarea id="custom-bubble-css" class="modal-textarea" style="font-family: monospace; font-size: 12px; height: 150px; white-space: pre;" placeholder=".message-sent {
  border-radius: 20px 20px 0 20px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.message-received {
  border-bottom: 2px solid var(--accent-color);
}"></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top:8px;">
                <button id="reset-css-btn" class="modal-btn modal-btn-secondary" style="padding: 6px 12px; font-size: 12px;">清空</button>
                <button id="apply-css-btn" class="modal-btn modal-btn-primary" style="padding: 6px 12px; font-size: 12px;">应用 CSS</button>
            </div>
            <div style="margin-top:14px;">
                <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;font-weight:500;letter-spacing:0.3px;">实时预览</div>
                <div id="css-live-preview" style="background:var(--chat-bg,var(--primary-bg));border-radius:14px;padding:14px 12px;border:1px solid var(--border-color);">
                    <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;">
                        <div style="width:32px;height:32px;border-radius:50%;background:var(--accent-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-user" style="font-size:12px;color:#fff;"></i>
                        </div>
                        <div class="message message-received" style="max-width:180px;">你是我朝夕相伴触手可及的虚拟</div>
                    </div>
                    <div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end;">
                        <div class="message message-sent" style="max-width:180px;">你是我未曾拥有无法捕捉的亲昵</div>
                        <div style="width:32px;height:32px;border-radius:50%;background:var(--border-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-user" style="font-size:12px;color:var(--text-secondary);"></i>
                        </div>
                    </div>
                </div>
                <style id="css-live-preview-style"></style>
            </div>
        </div>
    </div>
</div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 0;z-index:10;margin-top:8px;margin-left:-24px;margin-right:-24px;padding-left:24px;padding-right:24px;padding-bottom:max(12px, env(safe-area-inset-bottom, 0px));">
                <button class="modal-btn modal-btn-secondary" id="back-appearance" onclick="(function(){hideModal(document.getElementById('appearance-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> 返回
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-appearance">关闭</button>
            </div>
        </div>
    </div>


    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>聊天设置</span>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-user-edit"></i>昵称设置
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="(function(){var m=document.getElementById('edit-modal'),ti=m.querySelector('#edit-modal-title'),ni=m.querySelector('#name-input'),sb=m.querySelector('#save-name');ti.textContent='修改梦角的昵称';ni.value=(typeof settings!=='undefined'?settings.partnerName:'梦角');sb.disabled=!ni.value.trim();sb.onclick=function(){var n=ni.value.trim();if(n){settings.partnerName=n;var pEls=document.querySelectorAll('.username[data-role=partner],.partner-name,.contact-name');pEls.forEach(function(el){el.textContent=n;});if(typeof throttledSaveData==='function')throttledSaveData();if(typeof updateUI==='function')updateUI();if(typeof showNotification==='function')showNotification('梦角昵称已更新为「'+n+'」✦','success');}if(typeof hideModal==='function')hideModal(m);};if(typeof showModal==='function')showModal(m,ni);})()" style="flex:1;padding:11px 10px;border:1px solid var(--border-color);border-radius:12px;background:var(--primary-bg);color:var(--text-primary);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;font-family:var(--font-family);transition:all 0.2s;">
                        <i class="fas fa-user" style="color:var(--accent-color);font-size:14px;"></i>
                        <span>修改梦角名称</span>
                    </button>
                    <button onclick="(function(){var m=document.getElementById('edit-modal'),ti=m.querySelector('#edit-modal-title'),ni=m.querySelector('#name-input'),sb=m.querySelector('#save-name');ti.textContent='修改我的昵称';ni.value=(typeof settings!=='undefined'?settings.myName:'我');sb.disabled=!ni.value.trim();sb.onclick=function(){var n=ni.value.trim();if(n){settings.myName=n;if(typeof throttledSaveData==='function')throttledSaveData();if(typeof updateUI==='function')updateUI();if(typeof showNotification==='function')showNotification('我的昵称已更新为「'+n+'」✦','success');}if(typeof hideModal==='function')hideModal(m);};if(typeof showModal==='function')showModal(m,ni);})()" style="flex:1;padding:11px 10px;border:1px solid var(--border-color);border-radius:12px;background:var(--primary-bg);color:var(--text-primary);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;font-family:var(--font-family);transition:all 0.2s;">
                        <i class="fas fa-user-circle" style="color:var(--accent-color);font-size:14px;"></i>
                        <span>修改我方名称</span>
                    </button>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);margin-top:6px;opacity:0.7;">专为看不见顶部昵称的机型设置</div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-hourglass-half"></i>对方回复速度
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">最小间隔:</span>
                    <input type="range" min="1000" max="30000" step="1000" value="3000" class="font-size-slider" id="reply-delay-min-slider">
                    <span class="font-size-value" id="reply-delay-min-value">3s</span>
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">最大间隔:</span>
                    <input type="range" min="1000" max="120000" step="1000" value="7000" class="font-size-slider" id="reply-delay-max-slider">
                    <span class="font-size-value" id="reply-delay-max-value">7s</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-paper-plane"></i> 对方主动发消息
                </div>
                <div class="setting-pill-row" id="auto-send-toggle">
                    <span class="setting-pill-icon"><i class="fas fa-paper-plane"></i></span>
                    <span class="setting-pill-label">主动发送</span>
                    <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                </div>
                <div class="font-size-control" id="auto-send-control" style="display:none; margin-top:10px;">
                    <span class="font-size-label">间隔(分钟):</span>
                    <input type="range" min="1" max="120" step="1" value="5" class="font-size-slider" id="auto-send-slider">
                    <span class="font-size-value" id="auto-send-value">5分钟</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-sliders-h"></i>功能开关
                </div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div class="setting-pill-row" id="reply-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-reply"></i></span>
                        <span class="setting-pill-label">引用回复</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                    <div class="setting-pill-row" id="read-receipts-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-check-double"></i></span>
                        <span class="setting-pill-label">已读回执</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                    <div class="setting-pill-row" id="read-no-reply-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-comment-slash"></i></span>
                        <span class="setting-pill-label">已读不回</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                    <div class="setting-pill-row" id="typing-indicator-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-keyboard"></i></span>
                        <span class="setting-pill-label">正在输入</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-volume-up"></i>消息音效
                </div>
                <div class="setting-pill-row" id="sound-toggle" style="margin-bottom:10px;">
                    <span class="setting-pill-icon"><i class="fas fa-volume-up"></i></span>
                    <span class="setting-pill-label">消息音效</span>
                    <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                </div>
                <div id="sound-detail-section">
                    <div class="font-size-control" style="margin-bottom:8px;">
                        <span class="font-size-label">音量:</span>
                        <input type="range" min="0" max="100" step="5" value="15" class="font-size-slider" id="sound-volume-slider">
                        <span class="font-size-value" id="sound-volume-value">15%</span>
                    </div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;">自定义音效 URL（留空使用内置音效）</div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <input type="text" id="custom-sound-url-input" placeholder="https://example.com/sound.mp3" style="flex:1;padding:7px 10px;border:1px solid var(--border-color);border-radius:8px;font-size:12px;background:var(--primary-bg);color:var(--text-primary);outline:none;">
                        <button id="test-sound-btn" class="modal-btn modal-btn-secondary" style="padding:6px 10px;font-size:12px;white-space:nowrap;"><i class="fas fa-play"></i> 试听</button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-clock"></i>时间格式
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;" id="time-format-options">
                    <div class="settings-item time-fmt-opt active" data-fmt="HH:mm">
                        <i class="fas fa-clock"></i><span>14:05</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="HH:mm:ss">
                        <i class="fas fa-clock"></i><span>14:05:30</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="h:mm AM/PM">
                        <i class="fas fa-clock"></i><span>2:05 PM</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="h:mm:ss AM/PM">
                        <i class="fas fa-clock"></i><span>2:05:30 PM</span>
                    </div>
                </div>
            </div>

            

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-expand"></i>沉浸式聊天
                </div>
                <div class="setting-pill-row" id="immersive-toggle" onclick="toggleImmersiveMode()">
                    <span class="setting-pill-icon"><i class="fas fa-expand-arrows-alt"></i></span>
                    <span class="setting-pill-label">沉浸式模式 <span style="font-size:11px;color:var(--text-secondary);font-weight:400;">（隐藏顶部栏，专注聊天）</span></span>
                    <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                </div>
            </div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 0;z-index:10;margin-top:8px;margin-left:-24px;margin-right:-24px;padding-left:24px;padding-right:24px;padding-bottom:max(14px, env(safe-area-inset-bottom, 0px));">
                <button class="modal-btn modal-btn-secondary" id="back-chat" onclick="(function(){hideModal(document.getElementById('chat-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> 返回
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-chat">关闭</button>
            </div>
        </div>
    </div>

<div class="modal" id="advanced-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-tools"></i><span>高级功能</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-magic"></i>实用工具
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="custom-replies-function">
                        <i class="fas fa-comment-dots"></i><span>自定义回复</span>
                    </div>
                    <div class="settings-item" id="music-player-toggle">
                        <i class="fas fa-music"></i><span>悬浮音乐播放器</span>
                    </div>
                    <div class="settings-item" id="stats-function">
                        <i class="fas fa-chart-bar"></i><span>消息统计</span>
                    </div>
                    <div class="settings-item" id="decision-function">
                        <i class="fas fa-balance-scale"></i> 
                        <span>抉择</span> 
                    </div>
                    <div class="settings-item" id="fortune-lenormand-function" style="position:relative;">
                        <i class="fas fa-star-and-crescent"></i><span>运势 · 占卜</span>
                    </div>
                    <div class="settings-item" id="anniversary-function">
                        <i class="fas fa-heart"></i><span>重要日</span>
                    </div>
                    <div class="settings-item" id="mood-function">
                        <i class="fas fa-calendar-day"></i><span>心晴手账</span>
                    </div>
                    <div class="settings-item" id="envelope-function">
                        <i class="fas fa-envelope"></i><span>信封投递</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 0;z-index:10;margin-top:8px;margin-left:-24px;margin-right:-24px;padding-left:24px;padding-right:24px;padding-bottom:max(14px, env(safe-area-inset-bottom, 0px));">
                <button class="modal-btn modal-btn-secondary" id="back-advanced" onclick="(function(){hideModal(document.getElementById('advanced-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> 返回
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-advanced">关闭</button>
            </div>
        </div>
    </div>


    <div class="modal" id="data-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-database"></i><span>数据管理</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-bell"></i>消息通知
                </div>
                <div style="background:var(--primary-bg);border-radius:12px;padding:12px 14px;border:1px solid var(--border-color);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div>
                            <div style="font-size:13px;font-weight:500;color:var(--text-primary);">后台消息推送</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;">挂在后台时收到新消息自动弹出提醒</div>
                        </div>
                        <label class="notif-toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0;margin-left:12px;">
                            <input type="checkbox" id="notif-permission-toggle" style="opacity:0;width:0;height:0;" onchange="handleNotifToggle(this)">
                            <span class="notif-toggle-slider" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--border-color);border-radius:24px;transition:0.3s;"></span>
                        </label>
                    </div>
                    <div id="notif-status-text" style="font-size:11px;color:var(--text-secondary);margin-top:4px;"></div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-comments"></i>聊天记录
                </div>
                <div class="import-export-buttons">
                    <button class="import-export-btn" id="export-chat"><i class="fas fa-download"></i>导出记录</button>
                    <button class="import-export-btn export" id="import-chat"><i class="fas fa-upload"></i>导入记录</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-archive"></i>全量备份
                </div>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">包含外观、聊天设置、字卡、心情、信封等全部数据</div>
                <div class="import-export-buttons">
                    <button class="import-export-btn" id="export-all-settings"><i class="fas fa-download"></i>导出全部</button>
                    <button class="import-export-btn export" id="import-all-settings"><i class="fas fa-upload"></i>导入恢复</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-sync-alt"></i>重置数据
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="clear-storage">
                        <i class="fas fa-sync-alt"></i><span>重置数据</span>
                    </div>
                </div>
            </div>


            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-info-circle"></i>关于与声明
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="replay-tutorial-btn">
                        <i class="fas fa-question-circle"></i><span>重放新手引导</span>
                    </div>
                    <div class="settings-item" id="open-credits-btn">
                        <i class="fas fa-scroll"></i><span>声明与致谢</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 0;z-index:10;margin-top:8px;margin-left:-24px;margin-right:-24px;padding-left:24px;padding-right:24px;padding-bottom:max(14px, env(safe-area-inset-bottom, 0px));">
                <button class="modal-btn modal-btn-secondary" id="back-data" onclick="(function(){hideModal(document.getElementById('data-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> 返回
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-data">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal" id="stats-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-chart-bar"></i><span>消息统计 & 收藏</span>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:14px;">
                <button class="modal-btn modal-btn-primary" id="stats-tab-btn" onclick="switchStatsTab('stats')" style="flex:1;font-size:13px;padding:8px 0;">
                    <i class="fas fa-chart-bar"></i> 消息统计
                </button>
                <button class="modal-btn modal-btn-secondary" id="favorites-tab-btn" onclick="switchStatsTab('favorites')" style="flex:1;font-size:13px;padding:8px 0;">
                    <i class="fas fa-star"></i> 收藏夹
                </button>
            </div>
            <div id="stats-panel">
                <div class="stats-content" id="stats-content"></div>
            </div>
            <div id="favorites-panel" style="display:none;">
                <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
                    <button class="modal-btn modal-btn-secondary" id="batch-favorite-function" style="font-size:12px;padding:6px 14px;"><i class="fas fa-layer-group"></i> 批量收藏</button>
                </div>
                <div class="favorites-list" id="favorites-list" style="max-height:55vh;overflow-y:auto;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-stats">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal" id="session-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>会话管理</span>
            </div>
            <div class="session-list" id="session-list"></div>
            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="modal-btn modal-btn-primary" id="create-new-session"><i class="fas fa-plus"></i> 新建会话</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-session">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal" id="fortune-lenormand-modal">
        <div class="modal-content fl-modal-content">
            <div class="fl-tab-bar">
                <button class="fl-tab active" id="fl-tab-fortune" onclick="switchFLTab('fortune')">
                    <i class="fas fa-sun"></i> 每日运势
                </button>
                <button class="fl-tab" id="fl-tab-lenormand" onclick="switchFLTab('lenormand')">
                    <i class="fas fa-moon"></i> 雷诺曼占卜
                </button>
            </div>
            <div id="fl-panel-fortune" class="fl-panel fl-panel-active">
                <div id="fortune-content"></div>
                <div class="modal-buttons" style="margin-top:16px;">
                    <button class="modal-btn modal-btn-primary" id="share-fortune"><i class="fas fa-share-alt"></i> 分享运势</button>
                    <button class="modal-btn modal-btn-secondary" id="close-fortune">关闭</button>
                </div>
            </div>
            <div id="fl-panel-lenormand" class="fl-panel">
                <div id="lenormand-content">
                    <div id="lenormand-setup" style="padding: 4px 0 12px;">
                        <div class="leno-num-section">
                            <div class="leno-section-label"><i class="fas fa-layer-group"></i> 抽牌数量</div>
                            <div class="leno-num-btns">
                                <button class="lenormand-num-btn active" onclick="setLenormandCount(1)"><span class="leno-btn-num">1</span><span class="leno-btn-label">单张</span></button>
                                <button class="lenormand-num-btn" onclick="setLenormandCount(3)"><span class="leno-btn-num">3</span><span class="leno-btn-label">三张</span></button>
                            </div>
                            <div class="leno-num-desc" id="leno-num-desc">单张牌 · 直达答案</div>
                        </div>
                        <div class="leno-question-section">
                            <div class="leno-section-label"><i class="fas fa-feather-alt"></i> 你的提问（可选）</div>
                            <textarea id="lenormand-question" placeholder="将心中的疑问轻声诉说..." class="leno-question-input"></textarea>
                        </div>
                        <button class="modal-btn modal-btn-primary leno-draw-btn" onclick="startLenormandDraw()"><i class="fas fa-hand-sparkles"></i> 开始抽牌</button>
                    </div>
                    <div id="lenormand-result" style="display:none;"></div>
                </div>
                <div class="modal-buttons" style="margin-top:12px;">
                    <button class="modal-btn modal-btn-secondary" id="lenormand-reset-btn" onclick="resetLenormand()" style="display:none;">重新占卜</button>
                    <button class="modal-btn modal-btn-secondary" id="close-lenormand">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div id="fortune-modal" style="display:none;"></div>

    <div id="lenormand-modal" style="display:none;"></div>


    <div class="modal" id="mood-modal">
       <div class="modal-content">
        <div class="mood-header-actions">
            <div class="modal-title" style="margin-bottom:0; border:none; padding:0;">
                <i class="fas fa-book-open"></i><span>心晴手帐</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="view-switch-btn active" id="btn-view-calendar">
                    <i class="fas fa-calendar-alt"></i> 日历
                </button>
                <button class="view-switch-btn" id="btn-view-stats">
                    <i class="fas fa-chart-pie"></i> 统计
                </button>
            </div>
        </div>
        <div id="mood-calendar-view" class="mood-view-section">
            <div class="calendar-header">
                <button class="calendar-nav-btn" id="prev-month"><i class="fas fa-chevron-left"></i></button>
                <div class="current-month-label" id="calendar-month-label">--</div>
                <button class="calendar-nav-btn" id="next-month"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-weekdays">
                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    
        <div id="mood-stats-view" class="mood-view-section hidden-view">
            <div id="mood-stats-container" class="mood-stats-card" style="border:none; box-shadow:none; padding:0; background:transparent;">
            </div>
        </div>
    
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="close-mood">关闭</button>
        </div>
       </div>
    </div>

    <div class="mood-selector-overlay" id="mood-selector-overlay">
        <div class="mood-selector-card" id="mood-editor-view">
            <h3 id="mood-selector-date">--月--日</h3>
            
            <div id="mood-edit-target-tabs" style="display:flex; gap:6px; justify-content:center; margin:8px 0 4px;">
                <button class="mood-tab-btn active" id="mood-tab-me" onclick="switchMoodEditTarget('me')" data-name-me>我的记录</button>
                <button class="mood-tab-btn" id="mood-tab-partner" onclick="switchMoodEditTarget('partner')" data-name-partner>梦角的记录</button>
            </div>

            <div style="display:flex; align-items:center; justify-content:space-between; margin:8px 0 4px;">
                <button class="mood-page-btn" id="mood-page-prev" onclick="switchMoodPage(-1)">&#8249;</button>
                <span id="mood-page-indicator" style="font-size:12px; opacity:0.7;">第 1 页 · 心情</span>
                <button class="mood-page-btn" id="mood-page-next" onclick="switchMoodPage(1)">&#8250;</button>
            </div>

            <div id="mood-page-1">
                <div class="mood-options-slider-wrapper">
                    <div class="mood-options-grid" id="mood-options-grid"></div>
                </div>
                <button class="mood-custom-add-btn" id="mood-custom-add" onclick="openCustomMoodDialog()">
                    <i class="fas fa-plus"></i> 自定义心情
                </button>
            </div>

            <div id="mood-page-2" style="display:none;">
                <div class="mood-input-wrapper">
                    <label style="font-size:12px; font-weight:500;" id="mood-note-label">随记:</label>
                    <textarea id="mood-note-input" class="mood-note-input" rows="3" placeholder="记录下今天发生的小事..."></textarea>
                </div>
                <div style="margin-top:10px;">
                    <label style="font-size:12px; font-weight:500; display:flex; align-items:center; gap:5px; margin-bottom:6px;" id="mood-weather-label">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg>
                        今日天气&nbsp;
                    </label>
                    <input type="text" id="mood-weather-input" maxlength="20" placeholder="例如：晴朗 / 阴天 / 小雨..." style="width:100%; padding:9px 14px; border:1px solid var(--border-color); border-radius:10px; font-size:13px; background:var(--primary-bg); color:var(--text-primary); outline:none; font-family:var(--font-family);">
                </div>
            </div>
    
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="modal-btn modal-btn-secondary" id="cancel-mood-edit" style="flex:1;">取消</button>
                <button class="modal-btn modal-btn-secondary" id="view-mood-detail-btn" onclick="viewMoodDetailFromEditor()" style="flex:1;">查看详情</button>
                <button class="modal-btn modal-btn-primary" id="confirm-mood-save" style="flex:1;">保存</button>
            </div>
        </div>

        <div id="custom-mood-dialog" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--secondary-bg); padding:20px; border-radius:16px; width:80%; max-width:280px; z-index:2200; box-shadow:0 10px 30px rgba(0,0,0,0.3); text-align:center;">
            <h4 style="margin-bottom:12px; font-size:14px;">自定义心情</h4>
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <input id="custom-mood-emoji" type="text" maxlength="2" placeholder="表情" style="width:60px; text-align:center; border:1px solid var(--border-color); border-radius:8px; padding:8px; font-size:20px; background:var(--primary-bg); color:var(--text-primary);">
                <input id="custom-mood-label" type="text" maxlength="6" placeholder="名称（最多6字）" style="flex:1; border:1px solid var(--border-color); border-radius:8px; padding:8px; font-size:13px; background:var(--primary-bg); color:var(--text-primary);">
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center; margin-bottom:12px;">
                <span style="font-size:11px; opacity:0.6; width:100%;">选择颜色:</span>
                <div id="custom-mood-colors" style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center;"></div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="modal-btn modal-btn-secondary" onclick="closeCustomMoodDialog()" style="flex:1; font-size:12px;">取消</button>
                <button class="modal-btn modal-btn-primary" onclick="saveCustomMood()" style="flex:1; font-size:12px;">添加</button>
            </div>
        </div>
    
        <div class="day-detail-card" id="mood-detail-view" style="display:none; width:85%; max-width:320px;">
            <div class="day-detail-date" id="detail-date">--</div>
            <div id="detail-my-section" style="margin-bottom:12px;">
                <div style="font-size:11px; opacity:0.6; margin-bottom:6px; font-weight:600;">我的</div>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
                    <span id="detail-kaomoji" style="font-size:24px;"></span>
                    <span id="detail-label" style="font-weight:600;"></span>
                </div>
                <div class="day-detail-content" id="detail-text"></div>
                <div id="detail-my-weather" style="font-size:12px;color:var(--text-secondary);margin-top:4px;display:none;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg><span id="detail-my-weather-val"></span></div>
            </div>
                <div id="detail-partner-section" style="border-top:1px dashed var(--border-color); padding-top:10px; margin-top:4px;">
                <div style="font-size:11px; opacity:0.6; margin-bottom:6px; font-weight:600;" id="detail-partner-title">梦角的</div>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
                    <span id="detail-partner-kaomoji" style="font-size:24px;"></span>
                    <span id="detail-partner-label" style="font-weight:600;"></span>
                </div>
                <div class="day-detail-content" id="detail-partner-text"></div>
                <div id="detail-partner-weather" style="font-size:12px;color:var(--text-secondary);margin-top:4px;display:none;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg><span id="detail-partner-weather-val"></span></div>
            </div>
            <div id="detail-partner-no-record" style="display:none; border-top:1px dashed var(--border-color); padding-top:10px; margin-top:4px; font-size:13px; color:var(--text-secondary); font-style:italic; text-align:center;" id="detail-partner-no-record-msg">Ta 这天还没有留下记录</div>
            <div style="margin-top:20px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
                <button class="modal-btn modal-btn-secondary" onclick="closeMoodOverlay()" style="font-size:12px; padding:6px 12px;">关闭</button>
                <button class="modal-btn modal-btn-secondary" id="delete-my-mood" onclick="deleteDailyMood(selectedDateStr,'me')" style="font-size:12px; padding:6px 12px; color:#ff6b6b; border-color:rgba(255,107,107,0.4);" data-delete-me>删除我的</button>
                <button class="modal-btn modal-btn-secondary" id="delete-partner-mood" onclick="deleteDailyMood(selectedDateStr,'partner')" style="font-size:12px; padding:6px 12px; color:#ff6b6b; border-color:rgba(255,107,107,0.4);" data-delete-partner>删除梦角</button>
                <button class="modal-btn modal-btn-primary" id="edit-existing-mood" style="font-size:12px; padding:6px 12px;">修改我的</button>
                <button class="modal-btn modal-btn-primary" id="edit-partner-mood" onclick="editPartnerMoodRecord()" style="font-size:12px; padding:6px 12px; background:rgba(255,107,107,0.8);" data-edit-partner>修改梦角</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="theme-editor-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-palette"></i><span>主题编辑器</span></div>
            <div class="theme-editor-toolbar">
                <select id="theme-preset-selector" style="flex:1;"></select>
                <button id="overwrite-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 10px; display:none;" title="覆盖保存当前方案"><i class="fas fa-check"></i></button>
                <button id="save-theme-preset-btn" class="modal-btn modal-btn-primary" style="padding: 8px 10px;" title="另存为新方案"><i class="fas fa-save"></i></button>
                <button id="rename-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 10px;" title="重命名当前方案"><i class="fas fa-pen"></i></button>
                <button id="delete-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 10px;" title="删除当前方案"><i class="fas fa-trash"></i></button>
            </div>
            <div id="theme-editor-grid" class="theme-editor-grid">
            </div>
            <div class="modal-buttons" style="margin-top:12px;">
                <button class="modal-btn modal-btn-primary" id="apply-close-theme-editor" style="flex:2;"><i class="fas fa-check" style="margin-right:5px;"></i>应用并关闭</button>
                <button class="modal-btn modal-btn-secondary" id="close-theme-editor">取消</button>
            </div>
        </div>
    </div>

    <div class="modal" id="custom-replies-modal">
        <div class="modal-content">
            <div class="modal-sidebar">
                <button class="sidebar-btn active" data-major="reply">
                    <i class="fas fa-comment-dots"></i>
                    <span>回复库</span>
                </button>
                <button class="sidebar-btn" data-major="atmosphere">
                    <i class="fas fa-magic"></i>
                    <span>氛围感</span>
                </button>
                <button class="sidebar-btn" data-major="announcement" onclick="switchToAnnouncementPanel()">
                    <i class="fas fa-newspaper"></i>
                    <span>公告</span>
                </button>
            </div>
    
            <div class="modal-main-view">
                <div class="modal-title" style="padding: 15px 20px; font-size: 16px;">
                    <i class="fas fa-layer-group"></i> <span id="cr-modal-title">内容管理</span>
                </div>
    
                <div class="reply-tabs" id="cr-sub-tabs">
                </div>
    
                <div class="reply-toolbar" id="cr-toolbar">
                    <input type="text" class="reply-search" id="reply-search-input" placeholder="搜索...">
                    <button class="reply-tool-btn" id="import-replies-btn" title="导入"><i class="fas fa-file-import"></i></button>
                    <button class="reply-tool-btn" id="export-replies-btn" title="导出"><i class="fas fa-file-export"></i></button>
                </div>
    
                <div class="content-list-area" id="custom-replies-list">
                </div>

                <div id="announcement-panel" style="display:none; padding:0 16px 80px; overflow-y:auto; flex:1; min-height:0; -webkit-overflow-scrolling:touch;">
                    <div style="display:flex;flex-direction:column;gap:12px; padding:4px 0 16px;">
                        <div style="background:linear-gradient(135deg,rgba(var(--accent-color-rgb),0.12),rgba(var(--accent-color-rgb),0.05));border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.2);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-image" style="margin-right:6px;"></i>顶部背景图</div>
                            <div style="display:flex;gap:8px;">
                                <button onclick="document.getElementById('dg-header-img-input').click()" style="flex:1;padding:9px;border:1.5px dashed rgba(var(--accent-color-rgb),0.4);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                    上传顶部背景
                                </button>
                                <button onclick="clearDgHeaderBg()" style="padding:9px 14px;border:1px solid var(--border-color);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">清除</button>
                            </div>
                        </div>

                        <div style="background:rgba(var(--accent-color-rgb),0.05);border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.12);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-image" style="margin-right:6px;"></i>中部装饰图</div>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <button onclick="document.getElementById('dg-deco-img-input').click()" style="flex:1;padding:9px;border:1.5px dashed rgba(var(--accent-color-rgb),0.4);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                    上传装饰图
                                </button>
                                <button onclick="clearDgDecoImg()" style="padding:9px 14px;border:1px solid var(--border-color);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">清除</button>
                            </div>
                            <input type="file" id="dg-deco-img-input" accept="image/*" style="display:none">
                            <div id="dg-deco-preview" style="margin-top:8px;display:none;border-radius:10px;overflow:hidden;">
                                <img id="dg-deco-preview-img" src="" style="width:100%;max-height:100px;object-fit:cover;display:block;">
                            </div>
                        </div>

                        <div style="background:rgba(var(--accent-color-rgb),0.05);border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.12);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-edit" style="margin-right:6px;"></i>公告文案</div>
                            <div style="display:flex;flex-direction:column;gap:10px;">
                                <div>
                                    <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:5px;">公告标题 <span style="opacity:0.6;">（每行一条，随机显示）</span></label>
                                    <textarea id="dg-edit-title" rows="4" placeholder="每行一条，如：&#10;早上好&#10;七夕快乐&#10;思念你" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:10px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);resize:none;line-height:1.6;"></textarea>
                                </div>
                                <div>
                                    <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:5px;">每日寄语 <span style="opacity:0.6;">（每行一条，随机显示）</span></label>
                                    <textarea id="dg-edit-note" rows="5" placeholder="每行一条，如：&#10;今天也要元气满满，我在这里陪着你 ✦&#10;想你了，你有没有在想我呢" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:10px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);resize:none;line-height:1.6;"></textarea>
                                </div>
                                <button onclick="saveDailyGreetingCustom()" style="width:100%;padding:11px;background:var(--accent-color);color:white;border:none;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font-family);">
                                    <i class="fas fa-save" style="margin-right:6px;"></i>保存公告内容
                                </button>
                            </div>
                        </div>

                        <div style="background:rgba(var(--accent-color-rgb),0.05);border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.12);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-random" style="margin-right:6px;"></i>状态随机库</div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;line-height:1.5;">每次打开公告时，状态、英文标签、图标将从下方随机抽取一条。</div>
                            <div id="ann-status-pool-list" style="display:flex;flex-direction:column;gap:7px;margin-bottom:12px;max-height:200px;overflow-y:auto;"></div>
                            <div style="display:flex;flex-direction:column;gap:7px;">
                                <input type="text" id="ann-status-pool-input" placeholder="状态文案，如：在想你" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:9px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);">
                                <input type="text" id="ann-status-label-input" placeholder="英文标签，如：MISSING YOU" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:9px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);">
                                <div style="display:flex;gap:7px;align-items:center;">
                                    <div style="position:relative;flex:1;">
                                        <input type="text" id="ann-status-icon-input" placeholder="图标 emoji 或留空" style="width:100%;padding:9px 36px 9px 12px;border:1px solid var(--border-color);border-radius:9px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);box-sizing:border-box;">
                                        <button onclick="document.getElementById('ann-icon-img-input').click()" title="上传图片图标" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:22px;height:22px;background:rgba(var(--accent-color-rgb),0.15);border:none;border-radius:6px;cursor:pointer;font-size:10px;color:var(--accent-color);display:flex;align-items:center;justify-content:center;padding:0;"><i class="fas fa-image"></i></button>
                                        <input type="file" id="ann-icon-img-input" accept="image/*" style="display:none" onchange="handleAnnStatusIconUpload(this)">
                                    </div>
                                    <button onclick="addAnnStatusPoolItem()" style="padding:9px 18px;background:var(--accent-color);color:white;border:none;border-radius:9px;cursor:pointer;font-size:13px;font-weight:600;flex-shrink:0;font-family:var(--font-family);letter-spacing:0.5px;">添加</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-primary" id="add-custom-reply" style="flex: 1;">
                        <i class="fas fa-plus"></i> 新增
                    </button>
                    <button class="modal-btn modal-btn-secondary" id="close-custom-replies">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="import-replies-input" accept=".json" style="display: none;">
    <input type="file" id="background-input" class="file-input" accept="image/*">
    <input type="file" id="import-input" class="file-input" accept=".json">
    <input type="file" id="sticker-file-input" class="file-input" accept="image/*" multiple>

    <div class="coin-toss-overlay" id="coin-toss-overlay">
        <div class="coin-container">
            <div class="coin" id="animated-coin">
                <div class="coin-face coin-front">
                    <div class="coin-text-main">是</div>
                    <div class="coin-text-sub">YES</div>
                </div>
                <div class="coin-face coin-back">
                    <div class="coin-text-main">否</div>
                    <div class="coin-text-sub">NO</div>
                </div>
            </div>
        </div>
        <div class="coin-result-container">
            <div class="coin-result-text" id="coin-result-text"></div>
        </div>
        <div class="coin-confirm-buttons" id="coin-action-area">
            <button class="coin-btn-action" id="cancel-coin-result">取消</button>
            <button class="coin-btn-action" id="retry-coin-toss"><i class="fas fa-redo-alt"></i> 再来一次</button>
            <button class="coin-btn-action coin-btn-primary" id="send-coin-result">发送结果</button>
        </div>
    </div>

    <div class="modal" id="disclaimer-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-scroll"></i><span>关于 & 声明</span>
            </div>
            <div id="disclaimer-content" style="font-size: 14px; line-height: 1.8; color: var(--text-secondary); max-height: 50vh; overflow-y: auto; padding-right: 10px;">
                <div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                    <h3 style="color: var(--accent-color); margin-bottom: 10px;">特别鸣谢</h3>
                    <div style="text-align: center; margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--accent-color);">
                        <p style="margin: 5px 0; color: var(--text-primary);">
                            参考了 <strong>B站 @molina-3- 的传讯网站</strong>
                        </p>
                        <p style="margin: 5px 0; font-weight: bold; color: #e53935;">
                            如果需要更好的沟通体验 请支持哦！
                        </p>
                    </div>
                    <p>感谢 <strong>@苏铂潼</strong></p>
                    <p style="font-size: 12px; opacity: 0.8;">小红书号：9568228497</p>
                    <p style="font-size: 12px; margin-top: 5px; font-style: italic;">(聊天统计部分代码参考)</p>
                </div>
                <div style="margin-top: 15px;">
                    <p style="font-weight: bold; color: var(--text-primary); text-align: center;">
                        原创：小红书 @milk (1149615009)
                    </p>
                    <p style="color: #e53935; font-weight: bold; text-align: center; margin-top: 10px; border: 1px solid #e53935; padding: 5px; border-radius: 5px;">
                        此代码绝对禁止商用和盈利行为，一旦发现追究到底
                    </p>
                    <p style="text-align: center; margin-bottom: 15px;">支持二改二传，感谢使用！</p>
                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>反对性别暴力</b></li>
                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>尊重不该是奢求,安全必须是底线</b></li>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="accept-disclaimer" onclick="(function(){var m=document.getElementById('disclaimer-modal');if(m&&typeof hideModal==='function')hideModal(m);})()" style="width: 100%;">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal" id="anniversary-modal">
        <div class="modal-content">
            <div class="ann-header-card" id="ann-header-card" style="display: none;">
                <div class="ann-header-card-bg" id="ann-header-card-bg"></div>
                <div class="ann-header-card-overlay" id="ann-header-card-overlay"></div>
                <input type="file" id="ann-header-bg-input" accept="image/*" style="display:none;">
                <div class="ann-header-card-inner">
                    <span class="ann-header-icon" id="ann-header-icon">❤︎</span>
                    <span class="ann-header-label" id="ann-header-label">ANNIVERSARY</span>
                    <div class="ann-header-title" id="ann-header-title">纪念日</div>
                    <div class="ann-header-days" id="ann-header-days">0<span class="ann-header-days-unit">天</span></div>
                    <div class="ann-header-date" id="ann-header-date">--/--</div>
                    <div class="ann-header-milestones" id="ann-header-milestones"></div>
                </div>
            </div>
            <div id="ann-card-toolbar" style="display:none; padding:6px 14px 2px; align-items:center; justify-content:flex-end; gap:8px;">
                <button class="ann-header-upload-btn" onclick="document.getElementById('ann-header-bg-input').click()" title="更换背景图" style="position:static; background:rgba(var(--accent-color-rgb),0.1); border-color:rgba(var(--accent-color-rgb),0.3); color:var(--accent-color);">
                    <i class="fas fa-image"></i> 更换封面
                </button>
                <button class="ann-header-upload-btn" onclick="clearAnnCardBg()" title="清除背景图" style="position:static; background:rgba(var(--accent-color-rgb),0.05); border-color:rgba(var(--accent-color-rgb),0.2); color:var(--text-secondary);">
                    <i class="fas fa-times"></i> 清除
                </button>
            </div>
    
            <div class="ann-list-container" id="ann-list-container">
            </div>
    
            <div class="ann-footer">
                <button class="modal-btn modal-btn-secondary" id="close-anniversary-modal">关闭</button>
                <button class="modal-btn modal-btn-primary" id="open-ann-add-btn" style="flex: 1;">
                    <i class="fas fa-plus"></i> 新增纪念日
                </button>
            </div>
    
            <div class="ann-editor-slide" id="ann-editor-slide">
                <div class="ann-editor-header">
                    <button class="ann-back-btn" id="close-ann-editor"><i class="fas fa-arrow-left"></i></button>
                    <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M12 5v14M5 12h14"/></svg> 添加纪念日</span>
                </div>
                
                <div class="ann-editor-content">
                    <div class="ann-form-group">
                        <label class="ann-label"><i class="fas fa-tag"></i>标题名称</label>
                        <input type="text" class="modal-input" id="ann-input-name" placeholder="例如：恋爱纪念日、梦角生日">
                    </div>
    
                    <div class="ann-form-group">
                        <label class="ann-label"><i class="fas fa-calendar-alt"></i>选择日期</label>
                        <input type="date" class="modal-input" id="ann-input-date">
                    </div>
    
                    <div class="ann-form-group">
                        <label class="ann-label"><i class="fas fa-th-large"></i>类型</label>
                        <div class="ann-type-selector">
                            <div class="ann-type-btn active" data-type="anniversary" onclick="switchAnnType('anniversary')">
                                <i class="fas fa-heart"></i>
                                <span>纪念日</span>
                                <span class="ann-type-hint">过去 → 今天</span>
                            </div>
                            <div class="ann-type-btn" data-type="countdown" onclick="switchAnnType('countdown')">
                                <i class="fas fa-hourglass-half"></i>
                                <span>倒数日</span>
                                <span class="ann-type-hint">今天 → 未来</span>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px; opacity: 0.7; padding: 0 2px;">
                            <span id="ann-type-desc">计算从过去某一天到现在已经过了多少天</span>
                        </div>
                    </div>
    
                    <button class="modal-btn modal-btn-primary" id="save-ann-btn" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-check"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="anniversary-animation" id="anniversary-animation">
        <div class="anniversary-animation-content">
            <div class="anniversary-animation-title" id="anniversary-animation-title">
                纪念日快乐！
            </div>
            <div class="anniversary-animation-days" id="anniversary-animation-days">
                0
            </div>
            <div class="anniversary-animation-message" id="anniversary-animation-message">
                我们已经相伴了这么多天
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="close-anniversary-animation">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal" id="decision-menu-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-balance-scale"></i><span>抉择助手</span>
            </div>
            <div class="decision-menu-grid">
                <div class="decision-option-card" id="open-coin-toss">
                    <i class="fas fa-coins"></i>
                    <h3>抛硬币</h3>
                    <p>是 / 否 二元选择</p>
                </div>
                <div class="decision-option-card" id="open-wheel">
                    <i class="fas fa-magic"></i>
                    <h3>随机抽签</h3>
                    <p>自定义选项随机抽取</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-decision-menu">关闭</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="wheel-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-magic"></i><span>随机抽签</span>
            </div>
            
            <div class="picker-wrapper">
                <div class="picker-box-stage">
                    <div class="picker-cards-row" id="picker-cards-row"></div>
                    <div class="picker-result-text" id="wheel-result"></div>
                </div>
                <div class="picker-controls">
                    <div class="picker-options-label">选项列表（至少 2 项）</div>
                    <div class="picker-options-list" id="wheel-options-list"></div>
                    <button class="modal-btn modal-btn-secondary picker-add-btn" id="add-wheel-option">
                        <i class="fas fa-plus"></i> 添加选项
                    </button>
                </div>
            </div>
    
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-wheel">关闭</button>
                <button class="modal-btn modal-btn-primary" id="spin-wheel-btn"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 12a10 10 0 0 1 18.8-3.6M22 12a10 10 0 0 1-18.8 3.6"/></svg> 开始抽签</button>
                <button class="modal-btn modal-btn-primary" id="send-wheel-result" style="display:none;">发送结果</button>
            </div>
        </div>
    </div>

    <div class="player-container" id="player">
        <div class="mini-view" id="mini-view" title="点击展开">
            <div class="vinyl-record" id="vinyl-record-visual">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 13l-4-4h8l-4 4z" /></svg>
            </div>
        </div>
        <div class="full-view">
            <div class="minimize-btn" id="minimize-btn" title="收起">
                <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" /></svg>
            </div>
            <button id="upload-cover-btn" style="position: absolute; top: 12px; left: 15px; background: none; border: 1px dashed var(--border-color); color: var(--text-secondary); cursor: pointer; opacity: 0.7; z-index: 10; width: 24px; height: 24px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:12px;" title="更换专辑封面">
                <i class="fas fa-camera"></i>
            </button>
            <input type="file" id="cover-input" accept="image/*" style="display: none;">
            <div class="track-info">
                <div class="track-name" id="music-title">Loading...</div>
                <div class="track-sub" id="music-subtitle">...</div>
            </div>
            <div class="progress-wrapper" id="progress-area">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="controls">
                <button class="btn" id="mode-btn" title="切换模式">
                    <svg id="icon-loop" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" /></svg>
                    <svg id="icon-shuffle" style="display:none" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" /></svg>
                </button>
                <button class="btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" /></svg></button>
                <button class="btn btn-main" id="play-btn">
                    <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
                    <svg id="icon-pause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" /></svg>
                </button>
                <button class="btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" /></svg></button>
                <button class="btn" id="list-btn"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" /></svg></button>
            </div>
        </div>
    </div>
    <div class="playlist-popup" id="playlist"></div>
    <audio id="audio"></audio>

    <div class="modal" id="add-song-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-music"></i><span>添加自定义歌曲</span>
            </div>
            <input type="text" class="modal-input" id="new-song-title" placeholder="歌曲名称 (例如: 这里的风景)">
            <input type="text" class="modal-input" id="new-song-sub" placeholder="歌手/备注 (例如: 你的名字)">
            <input type="text" class="modal-input" id="new-song-url" placeholder="音频链接 (mp3/m4a 链接)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-add-song">取消</button>
                <button class="modal-btn modal-btn-primary" id="confirm-add-song">添加播放</button>
            </div>
        </div>
    </div>

<script type="module" src="main.js"></script>
<div id="daily-greeting-modal" class="hidden">
    <div class="daily-greeting-card" id="daily-greeting-card">
        <div class="dg-header-band" id="dg-header-band">
            <div class="dg-header-band-bg" id="dg-header-band-bg"></div>
            <div class="dg-header-band-overlay" id="dg-header-band-overlay"></div>
            <div class="dg-header-band-shimmer"></div>
            <input type="file" id="dg-header-img-input" accept="image/*" style="display:none">
            <div class="dg-header-top">
                <div class="dg-emoji-circle" id="dg-emoji">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                </div>
                <div class="dg-header-text">
                    <div class="dg-festival-label" id="dg-festival">GOOD MORNING</div>
                    <div class="dg-main-title" id="dg-title">早上好</div>
                </div>
            </div>
            <div class="dg-date-stamp" id="dg-date-stamp">— 今日公告已送达 —</div>
        </div>
        <div class="dg-body">
            <div class="dg-section-label" id="dg-section-label-partner">梦角今日状态</div>
            <div class="dg-mood-panel" id="dg-mood-panel">
                <div class="dg-mood-icon-big" id="dg-partner-mood-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                </div>
                <div class="dg-mood-info">
                    <div class="dg-mood-name" id="dg-partner-mood">还没有记录今日心情</div>
                    <div class="dg-mood-sub" id="dg-partner-mood-note"></div>
                </div>
            </div>
            <div class="dg-info-grid">
                <div class="dg-info-cell">
                    <div class="dg-info-cell-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg>
                    </div>
                    <div class="dg-info-cell-label" id="dg-weather-label"</>梦角的天气</div>
                    <div class="dg-info-cell-val" id="dg-weather" onclick="startEditDgWeather(this)" style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:3px;" title="点击编辑">晴朗</div>
                </div>
                <div class="dg-info-cell">
                    <div class="dg-info-cell-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    </div>
                    <div class="dg-info-cell-label" id="dg-status-label">梦角的状态</div>
                    <div class="dg-info-cell-val" id="dg-status">一切都好</div>
                </div>
            </div>
            <div id="dg-deco-img-wrap" style="display:none; margin-bottom:12px; border-radius:12px; overflow:hidden;">
                <img id="dg-deco-img" src="" alt="" style="width:100%; max-height:160px; object-fit:cover; display:block; border-radius:12px;">
            </div>
            <div class="dg-note-box" id="dg-note">
                <div class="dg-note-inner">
                    <div class="dg-note-weather-badge" id="dg-note-weather-badge" style="display:none;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg>
                        <span id="dg-note-weather-text"></span>
                    </div>
                    <div id="dg-note-text">今天也要元气满满，我在这里陪着你 ✦</div>
                </div>
            </div>
            <div class="dg-footer">
                <button class="daily-greeting-close-btn" onclick="closeDailyGreeting()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align:-2px;margin-right:6px"><polyline points="20 6 9 17 4 12"/></svg>
                    知道了，开始今天
                </button>
            </div>
        </div>

    </div>
</div>

<div id="dg-editor-modal" style="display:none;"></div>
</body>
</html>